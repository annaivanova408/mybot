<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>AR(1) –≥—Ä–∞—Ñ–∏–∫</title>
  <style>
    body {
      margin: 0;
      background: #111;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }
    canvas {
      max-width: 90vw;
      max-height: 50vh;
      background: #fff;
      margin-bottom: 20px;
      border-radius: 8px;
    }
    button {
      width: 80%;
      padding: 12px 16px;
      margin: 6px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    .up    { background: #2ecc71; color: #fff; }
    .down  { background: #e74c3c; color: #fff; }
    .send  { background: #3498db; color: #fff; margin-top: 12px; }
    .hint  { font-size: 14px; color: #ccc; margin-bottom: 8px; }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <canvas id="plot" width="800" height="400"></canvas>

  <div class="hint" id="status">–°–¥–µ–ª–∞–π –≤—ã–±–æ—Ä –∏ –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ –æ–±–Ω–æ–≤–ª—è–π –≥—Ä–∞—Ñ–∏–∫, –ø–æ—Ç–æ–º –Ω–∞–∂–º–∏ ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç¬ª.</div>

  <button class="up"   onclick="onChoice(1)">–¶–µ–Ω–∞ —Ä–∞—Å—Ç—ë—Ç üìà</button>
  <button class="down" onclick="onChoice(0)">–¶–µ–Ω–∞ –ø–∞–¥–∞–µ—Ç üìâ</button>
  <button class="send" onclick="sendAnswer()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç ‚úÖ</button>

  <script>
    // —á–∏—Ç–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä phi –∏–∑ URL, –Ω–∞–ø—Ä–∏–º–µ—Ä ?phi=0.7
    const params = new URLSearchParams(window.location.search);
    const phi = parseFloat(params.get("phi")) || 0.5;

    let lastChoice = null; // 1 –∏–ª–∏ 0

    // –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è (Box‚ÄìMuller)
    function randn() {
      const u = 1 - Math.random();
      const v = 1 - Math.random();
      return Math.sqrt(-2 * Math.log(u)) * Math.cos(2 * Math.PI * v);
    }

    function generateAR1(n, phi, sigma) {
      const eps = [];
      for (let i = 0; i < n; i++) eps.push(sigma * randn());
      const X = [eps[0]];
      for (let t = 1; t < n; t++) {
        X.push(phi * X[t-1] + eps[t]);
      }
      return X;
    }

    const n = 100;
    const sigma = 0.5;
    const canvas = document.getElementById("plot");
    const ctx = canvas.getContext("2d");

    function drawSeries(data) {
      const min = Math.min(...data);
      const max = Math.max(...data);
      const pad = 30;

      function yScale(v) {
        if (max === min) return canvas.height / 2;
        return pad + (canvas.height - 2*pad) * (1 - (v - min) / (max - min));
      }

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // –æ—Å—å X
      ctx.strokeStyle = "#ccc";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(pad, canvas.height - pad);
      ctx.lineTo(canvas.width - pad, canvas.height - pad);
      ctx.stroke();

      // –ª–∏–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞
      ctx.strokeStyle = "#f1a520";
      ctx.lineWidth = 2;
      ctx.beginPath();
      for (let i = 0; i < data.length; i++) {
        const x = pad + (canvas.width - 2*pad) * (i / (data.length - 1));
        const y = yScale(data[i]);
        if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
      }
      ctx.stroke();

      // –ø–æ–¥–ø–∏—Å—å –ø—Ä–æ phi
      ctx.fillStyle = "#000";
      ctx.font = "20px system-ui";
      ctx.fillText("AR(1), œÜ = " + phi.toFixed(2), pad, pad);
    }

    function regeneratePlot() {
      const data = generateAR1(n, phi, sigma);
      drawSeries(data);
    }

    // –ø–µ—Ä–≤—ã–π —Ä–µ–Ω–¥–µ—Ä
    regeneratePlot();

    function onChoice(val) {
      lastChoice = val;
      const status = document.getElementById("status");
      status.textContent = val === 1
        ? "–í—ã –≤—ã–±—Ä–∞–ª–∏: –¶–µ–Ω–∞ —Ä–∞—Å—Ç—ë—Ç üìà. –ú–æ–∂–µ—à—å –æ–±–Ω–æ–≤–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç."
        : "–í—ã –≤—ã–±—Ä–∞–ª–∏: –¶–µ–Ω–∞ –ø–∞–¥–∞–µ—Ç üìâ. –ú–æ–∂–µ—à—å –æ–±–Ω–æ–≤–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç.";
      // –æ–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –ø–æ–¥ –Ω–æ–≤—ã–π —à—É–º
      regeneratePlot();
    }

    function sendAnswer() {
      if (lastChoice === null) {
        const status = document.getElementById("status");
        status.textContent = "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –≤–∞—Ä–∏–∞–Ω—Ç (üìà –∏–ª–∏ üìâ), –ø–æ—Ç–æ–º –æ—Ç–ø—Ä–∞–≤–ª—è–π –æ—Ç–≤–µ—Ç.";
        return;
      }
      Telegram.WebApp.sendData(lastChoice.toString());
      // –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –º–∏–Ω–∏-–∞–ø–ø –∑–∞–∫—Ä–æ–µ—Ç—Å—è –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º Telegram
    }
  </script>
</body>
</html>